@model AddOrderViewModel
@{
    ViewData["Title"] = "Add Order - Table " + Model.TableId;
    Layout = "_AdminLayout";
}

<div class="add-order-page">

@section Styles {
    <link rel="stylesheet" href="~/css/admin-styles.css" />
}

<!-- Page Header -->
<header class="page-header">
    <div class="header-content">
        <div class="header-left">
            <h1 class="page-title">
                <i class="fas fa-plus-circle"></i>
                Add Order to Table @Model.TableId
            </h1>
            <p class="page-subtitle">Select menu items to add to the current order</p>
        </div>
        <div class="header-actions">
            <a asp-action="TableDetails" asp-route-tableId="@Model.TableId" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Table Details
            </a>
        </div>
    </div>
</header>

<!-- Floating Success Message -->
@if (TempData["SuccessMessage"] != null)
{
    <div id="floatingSuccessMessage" class="floating-success-message">
        <i class="fas fa-check-circle"></i>
        @TempData["SuccessMessage"]
    </div>
}

<!-- Error Messages -->
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Content Grid -->
<section class="content-grid">
    <!-- Filters Section -->
    <section class="filters-section">
        <div class="filters-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="menuSearch" placeholder="Search menu items..." />
            </div>
            <div class="filter-controls">
                <select id="categoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                    @if (ViewBag.Categories != null)
                    {
                        @foreach (var category in ViewBag.Categories)
                        {
                            <option value="@category.Name">@category.Name</option>
                        }
                    }
                </select>
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                </select>
                <button class="clear-filters" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
    </section>

    <!-- Menu Items Section -->
    <div class="menu-items-section">
        <div class="menu-header">
            <h3>
                <i class="fas fa-utensils"></i>
                Menu Items
            </h3>
            <div class="results-counter">
                <span id="results-count">@Model.MenuItems.Count items</span>
            </div>
        </div>
        
        <div class="menu-items-container">
            <div class="menu-items-grid" id="menu-items">
                @{
                    var groupedItems = Model.MenuItems
                        .GroupBy(item => item.Category?.Name ?? "Uncategorized")
                        .OrderBy(group => group.First().Category?.DisplayOrder ?? 999)
                        .ThenBy(group => group.Key);
                }
                @foreach (var categoryGroup in groupedItems)
                {
                    <div class="category-section" data-category="@categoryGroup.Key">
                        <div class="category-section-header">
                            <h3 class="category-title">@categoryGroup.Key</h3>
                            <div class="category-line"></div>
                        </div>
                        <div class="category-items">
                            @foreach (var item in categoryGroup.OrderBy(i => i.Name?.ToString() ?? ""))
                            {
                                <div class="menu-item-card @(item.IsAvailable ? "available" : "unavailable")" 
                                     data-name="@(item.Name?.ToLower() ?? "")" 
                                     data-category="@(item.Category?.Name?.ToLower() ?? "")" 
                                     data-status="@(item.IsAvailable ? "available" : "unavailable")">
                                    
                                    <!-- Item Image -->
                                    <div class="item-image">
                                        @if (!string.IsNullOrEmpty(item.ImagePath))
                                        {
                                            <img src="@item.ImagePath" alt="@(item.Name ?? "Menu Item")" />
                                        }
                                        else
                                        {
                                            <div class="image-placeholder">
                                                <i class="fas fa-utensils"></i>
                                            </div>
                                        }
                                        @if (!item.IsAvailable)
                                        {
                                            <div class="unavailable-overlay">
                                                <i class="fas fa-eye-slash"></i>
                                                <span>Unavailable</span>
                                            </div>
                                        }
                                        <div class="item-badges">
                                            <span class="category-badge">@(item.Category?.Name ?? "Uncategorized")</span>
                                            <span class="status-badge @(item.IsAvailable ? "available" : "unavailable")">
                                                @(item.IsAvailable ? "Available" : "Unavailable")
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Item Details -->
                                    <div class="item-details">
                                        <h3 class="item-name">@(item.Name ?? "Unnamed Item")</h3>
                                        <p class="item-description">@(item.Description ?? "No description available")</p>
                                        
                                        <div class="item-meta">
                                            <div class="price-section">
                                                <span class="item-price">$@item.Price.ToString("F2")</span>
                                            </div>
                                        </div>

                                        <!-- Action Button -->
                                        <div class="item-actions">
                                            <form asp-action="AddOrderItem" method="post" class="add-to-order-form">
                                                <input type="hidden" name="TableId" value="@Model.TableId" />
                                                <input type="hidden" name="MenuItemId" value="@item.Id" />
                                                <input type="hidden" name="quantity" value="1" />
                                                <button type="submit" class="action-btn add" @(item.IsAvailable ? "" : "disabled") title="Add to Order">
                                                    <i class="fas fa-plus"></i>
                                                    Add to Order
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- No Results Message -->
        <div class="no-results" id="no-results" style="display: none;">
            <div class="no-results-content">
                <i class="fas fa-search"></i>
                <h4>No menu items found</h4>
                <p>Try adjusting your search terms or filters</p>
                <button type="button" class="btn btn-outline" onclick="clearFilters()">
                    <i class="fas fa-refresh"></i>
                    Clear All Filters
                </button>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Search and filter functionality
        document.getElementById('menuSearch').addEventListener('input', filterItems);
        document.getElementById('categoryFilter').addEventListener('change', filterItems);
        document.getElementById('statusFilter').addEventListener('change', filterItems);

        function filterItems() {
            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const items = document.querySelectorAll('.menu-item-card');
            const categorySections = document.querySelectorAll('.category-section');
            let visibleCount = 0;

            categorySections.forEach(section => {
                const sectionItems = section.querySelectorAll('.menu-item-card');
                let sectionVisibleCount = 0;
                
                sectionItems.forEach(item => {
                    const name = item.dataset.name;
                    const category = item.dataset.category;
                    const status = item.dataset.status;

                    const matchesSearch = name.includes(searchTerm);
                    const matchesCategory = !categoryFilter || category === categoryFilter;
                    const matchesStatus = !statusFilter || status === statusFilter;

                    if (matchesSearch && matchesCategory && matchesStatus) {
                        item.style.display = 'block';
                        item.style.animation = 'fadeIn 0.3s ease';
                        visibleCount++;
                        sectionVisibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show/hide entire category section based on visible items
                if (sectionVisibleCount > 0) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });

            // Update results counter
            document.getElementById('results-count').textContent = `${visibleCount} item${visibleCount !== 1 ? 's' : ''}`;

            // Show/hide no results message
            const noResults = document.getElementById('no-results');
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        function clearFilters() {
            document.getElementById('menuSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterItems();
        }

        // Auto-hide floating success message
        document.addEventListener('DOMContentLoaded', function() {
            const floatingMessage = document.getElementById('floatingSuccessMessage');
            if (floatingMessage) {
                setTimeout(function() {
                    floatingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(function() {
                        floatingMessage.remove();
                    }, 300);
                }, 2000);
            }
        });
    </script>
}

</div>